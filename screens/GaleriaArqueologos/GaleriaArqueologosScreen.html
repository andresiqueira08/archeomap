<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Galeria - Arque√≥logos</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/mobile.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
      #btnAddMap {
        position: fixed !important; bottom: 84px !important; right: 16px !important;
        left: auto !important; top: auto !important; transform: none !important;
        z-index: 1200 !important; width: auto !important; padding: 12px 18px !important;
        border-radius: 10px !important;
      }
      .loading-spinner { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="screen galeria-screen active">
        <div class="page">
            <div class="top-bar">
                <div class="top"></div>
                <div class="content">
                    <div class="title">Mapas na Nuvem</div>
                    <div class="icon-buttons"><div class="icon" id="btnProfile">üë§</div></div>
                </div>
            </div>
            
            <div class="list">
                <div class="section-title">
                    <div class="text">
                        <div class="title3">Projetos Ativos</div>
                        <div class="subtitle">Sincronizados em tempo real</div>
                    </div>
                </div>
                
                <div id="loading" class="loading-spinner">Carregando mapas...</div>
                <div class="galeria-grid" id="galeriaGrid"></div>
                
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">üó∫Ô∏è</div>
                    <h3>Nenhum mapa encontrado</h3>
                    <p>Crie um novo mapa para come√ßar a colaborar.</p>
                </div>
            </div>
            
            <div class="secondary" id="btnAddMap"><div class="title10">+ Novo Trabalho</div></div>
            
            <div class="bottom-nav">
                <div class="tab active" id="tabGaleria">
                    <div class="icon2">üè†</div><div class="title9">Galeria</div>
                </div>
                <div class="tab" id="tabPerfil">
                    <div class="icon2">üë§</div><div class="title9">Perfil</div>
                </div>
            </div>
            
            <div class="modal" id="mapModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Adicionar Mapa</div>
                        <button class="close-modal" id="closeMapModal">&times;</button>
                    </div>
                    <div class="modal-options">
                        <div class="modal-option" id="optionGallery"><span>üì∑</span> Abrir galeria</div>
                        <div class="modal-option" id="optionFiles"><span>üìÅ</span> Abrir arquivos</div>
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <div class="notification" id="notification"></div>
        </div>
    </div>

    <script src="../../js/firebase-config.js"></script>

    <script>
        // Elementos UI
        const galeriaGrid = document.getElementById('galeriaGrid');
        const emptyState = document.getElementById('emptyState');
        const loadingDiv = document.getElementById('loading');
        const btnAddMap = document.getElementById('btnAddMap');
        const mapModal = document.getElementById('mapModal');
        const closeMapModal = document.getElementById('closeMapModal');
        const fileInput = document.getElementById('fileInput');
        const imageInput = document.getElementById('imageInput');
        const notification = document.getElementById('notification');
        
        let currentUser = null;

        // Verifica autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadMapsFromFirebase();
            } else {
                window.location.href = '../Login/LoginScreen.html';
            }
        });

        // --- FUN√á√ïES DE BANCO DE DADOS (FIREBASE) ---

        function loadMapsFromFirebase() {
            // Escuta em tempo real a pasta 'maps' do banco de dados
            database.ref('maps').on('value', (snapshot) => {
                loadingDiv.style.display = 'none';
                galeriaGrid.innerHTML = '';
                const mapsData = snapshot.val();

                if (!mapsData) {
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                // Transforma objeto em array
                const mapsList = Object.keys(mapsData).map(key => ({
                    id: key,
                    ...mapsData[key]
                }));
                
                // Ordena por data (mais recente primeiro)
                mapsList.reverse().forEach(renderMapCard);
            });
        }

        function renderMapCard(map) {
            const mapCard = document.createElement('div');
            mapCard.className = 'map-card';
            mapCard.innerHTML = `
                <div class="map-card-image">
                    <img src="${map.image}" alt="${map.name}">
                    <div class="map-card-overlay">
                        <div class="map-stats"><span>${map.pointsCount || 0} pontos</span></div>
                    </div>
                </div>
                <div class="map-card-info">
                    <h4 class="map-card-title">${map.name}</h4>
                    <p class="map-card-date">Criado por: ${map.authorName || 'Desconhecido'}</p>
                </div>
            `;
            mapCard.addEventListener('click', () => {
                // Salva ID no localStorage para a tela de colabora√ß√£o saber qual carregar
                localStorage.setItem('currentMapId', map.id);
                // Tamb√©m salva o objeto completo para carregamento r√°pido
                localStorage.setItem('currentMap', JSON.stringify(map));
                window.location.href = '../../screens/Colaboracao/ColaboracaoScreen.html';
            });
            galeriaGrid.appendChild(mapCard);
        }

        function addNewMap(imageSrc) {
            if (!currentUser) return;

            const newMapKey = database.ref().child('maps').push().key;
            const newMap = {
                id: newMapKey,
                name: `Mapa ${new Date().toLocaleDateString('pt-BR')}`,
                image: imageSrc,
                createdDate: new Date().toISOString(),
                authorId: currentUser.uid,
                authorName: JSON.parse(localStorage.getItem('user'))?.name || 'Arque√≥logo',
                pointsCount: 0,
                pointsData: []
            };

            // Salva no Firebase
            database.ref('maps/' + newMapKey).set(newMap)
                .then(() => {
                    showNotification('Mapa enviado para a nuvem!');
                    mapModal.style.display = 'none';
                })
                .catch(err => showNotification('Erro ao salvar: ' + err.message, 'error'));
        }

        // --- HANDLERS DE UI ---

        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Otimiza√ß√£o: Imagens muito grandes travam o Realtime Database
                    // Idealmente usar√≠amos Firebase Storage, mas para manter simples usaremos Base64
                    // com um aviso se for muito grande.
                    addNewMap(e.target.result);
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function showNotification(msg, type='success') {
            notification.textContent = msg;
            notification.style.display = 'block';
            notification.style.background = type === 'success' ? '#7D1B1C' : '#f56565';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        // Event Listeners
        btnAddMap.addEventListener('click', () => {
             mapModal.style.display = 'flex';
             mapModal.classList.add('active');
        });
        closeMapModal.addEventListener('click', () => {
             mapModal.style.display = 'none';
             mapModal.classList.remove('active');
        });
        document.getElementById('optionGallery').addEventListener('click', () => document.getElementById('imageInput').click());
        document.getElementById('optionFiles').addEventListener('click', () => document.getElementById('fileInput').click());
        
        fileInput.addEventListener('change', handleImageSelection);
        imageInput.addEventListener('change', handleImageSelection);
        document.getElementById('btnProfile').addEventListener('click', () => window.location.href = '../PerfilUsuario/PerfilUsuarioScreen.html');
        document.getElementById('tabPerfil').addEventListener('click', () => window.location.href = '../PerfilUsuario/PerfilUsuarioScreen.html');
    </script>
</body>
</html>